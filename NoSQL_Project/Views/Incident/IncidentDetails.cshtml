@using NoSQL_Project.Models.Enums
@model NoSQL_Project.Models.Incident

@{
    ViewData["Title"] = "Incident Details";
    bool isEditing = ViewBag.IsEditing ?? false;
}
<h1 class="incident_details_title">Incident Details</h1>
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">
        @TempData["Error"]
    </div>
}
@{
    string incidentStatusStyle = "";
    string priorityLevelStyle = "";
    // Determine priority style
    switch (Model.Priority)
    {
        case Priority.low:
            priorityLevelStyle = "priority_low";
            break;
        case Priority.medium:
            priorityLevelStyle = "priority_medium";
            break;
        case Priority.high:
            priorityLevelStyle = "priority_high";
            break;
        case Priority.critical:
            priorityLevelStyle = "priority_critical";
            break;
    }
    // Determine status style
    switch (Model.Status)
    {
        case IncidentStatus.open:
            incidentStatusStyle = "status_open";
            break;
        case IncidentStatus.resolved:
            incidentStatusStyle = "status_closed";
            break;
        case IncidentStatus.closed_without_resolve:
            incidentStatusStyle = "status_in_progress";
            break;
    }
}

<form asp-action="UpdateIncident" method="post"> <input type="hidden" asp-for="Id" />


<div class="incident_layout">
    <header class="incident_main_header">
        <h4>@Model.Location?.Branch > #ID @Model.Id</h4>
            <input type="hidden" asp-for="Location.Branch" />
            <input type="hidden" asp-for="Location.Region" />
        <h2>@Model.Subject</h2>
            <input type="hidden" asp-for="Subject" />
        <p>@Model.Description</p>
            <input type="hidden" asp-for="Description" />
    </header>

    <article class="incident_other_information">
        <div class="other_information_container">
            <h3 class="incident_details_title title">Other Information</h3>

            <!-- Incident Type -->
            <div class="other_information_row">
                <p>Type:</p>
                @if (isEditing)
                {
                    <select asp-for="IncidentType" asp-items="Html.GetEnumSelectList<IncidentType>()" class="form-control"></select>
                }
                else
                {
                    <h4>@Model.IncidentType</h4>
                }
            </div>

            <!-- Priority -->
            <div class="other_information_row">
                <p>Priority:</p>
                @if (isEditing)
                {
                    <select asp-for="Priority" asp-items="Html.GetEnumSelectList<Priority>()" class="form-control"></select>
                }
                else
                {
                    <h4>@Model.Priority</h4>
                }
            </div>

            <!-- Status -->
            <div class="other_information_row">
                <p>Status:</p>
                @if (isEditing)
                {
                    <select asp-for="Status" asp-items="Html.GetEnumSelectList<IncidentStatus>()" class="form-control"></select>
                }
                else
                {
                    <h4>@Model.Status</h4>
                }
            </div>

            <!-- Deadline -->
            <div class="other_information_row">
                <p>Deadline:</p>
                @if (isEditing)
                {
                    <select asp-for="Deadline" class="form-control">
                        <option value="@DateTime.UtcNow.AddDays(7).ToString("o")"
                                selected="@(Model.Deadline.Date == DateTime.UtcNow.AddDays(7).Date)">
                            7 days
                        </option>
                        <option value="@DateTime.UtcNow.AddDays(14).ToString("o")"
                                selected="@(Model.Deadline.Date == DateTime.UtcNow.AddDays(14).Date)">
                            14 days
                        </option>
                        <option value="@DateTime.UtcNow.AddDays(28).ToString("o")"
                                selected="@(Model.Deadline.Date == DateTime.UtcNow.AddDays(28).Date)">
                            28 days
                        </option>

                    </select>
                }
                else
                {
                    <h4>@Model.Deadline.ToString("g")</h4>
                }
            </div>

            <!-- Assigned To -->
            <div class="other_information_row">
                    <p>Assigned To:</p>
                    @{
                        var activeUserIndex = Model.AssignedTo?.FindIndex(u => u.IsActive) ?? -1;
                    }

                    @if (activeUserIndex >= 0)
                    {
                        var activeUser = Model.AssignedTo[activeUserIndex];
                        <h4>@activeUser.FirstName @activeUser.LastName</h4>
                        <input type="hidden" name="AssignedTo[@activeUserIndex].FirstName" value="@activeUser.FirstName" />
                        <input type="hidden" name="AssignedTo[@activeUserIndex].LastName" value="@activeUser.LastName" />
                        <input type="hidden" name="AssignedTo[@activeUserIndex].IsActive" value="@activeUser.IsActive" />
                    }
                    else
                    {
                        <h4>Incident not yet assigned</h4>
                    }
            </div>


            <div class="other_information_row">
                <p>Created on:</p>
                <h4>@Model.ReportedAt.ToString("g")</h4>
                    <input type="hidden" asp-for="ReportedAt" />
            </div>
            <div class="other_information_row">
                <p>Reported by:</p>
                <h4>@Model.ReportedBy?.FirstName @Model.ReportedBy?.LastName</h4>
                    <input type="hidden" asp-for="ReportedBy.FirstName" />
                    <input type="hidden" asp-for="ReportedBy.LastName" />
            </div>
            <div class="other_information_row">
                <p>Branch:</p>
                <h4>@Model.Location?.Branch</h4>
                <input type="hidden" asp-for="Location.Branch" />
            </div>
        </div>     
    </article>
    </div>


<div class="incident_management_buttons">
    @if (isEditing) //Service Desk employees can edit de form 
    {        
            <button type="submit" class="btn btn-success">Save</button>
            <a asp-action="IncidentDetails" asp-route-id="@Model.Id" class="btn btn-secondary">Cancel</a>      
    }
    else
    {
        <a asp-action="EditIncident" asp-route-id="@Model.Id" class="btn btn-primary">Edit</a>          
        
    }
</div>
</form>


<form asp-action="CloseIncident" method="post">
    <input type="hidden" name="incidentId" value="@Model.Id" />
    <input type="hidden" name="updatedStatus" value="resolved" />
    <button type="submit">Resolve </button>
</form>

<form asp-action="CloseIncident" method="post">
    <input type="hidden" name="incidentId" value="@Model.Id" />
    <input type="hidden" name="updatedStatus" value="closed_without_resolve" />
    <button type="submit">Close Incident</button>
</form>

<form asp-action="TransferIncident" method="get">
    <input type="hidden" name="incidentId" value="@Model.Id" />
    <button type="submit">Transfer Incident</button>
</form>




